<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RCCM 問題4-1</title>
  <style>
    :root{
      --bg:#f6f9ff; --panel:#ffffff; --muted:#4b5563; --text:#111827; --accent:#2563eb;
      --ok:#16a34a; --bad:#dc2626; --border:#cbd5e1;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.12);
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,"Noto Sans JP",sans-serif}
    .wrapper{min-height:100%;display:flex;flex-direction:column}

    /* Header */
    header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .container{max-width:880px;margin:0 auto;padding:14px 16px}
    .title{font-weight:800;text-align:center;letter-spacing:.02em;font-size:clamp(20px,4.5vw,28px);color:var(--accent)}

    /* Main */
    main{flex:1}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .year-no{display:flex;gap:8px;color:var(--muted);font-size:.95rem;align-items:center;margin-bottom:8px}
    .question{font-size:clamp(16px,3.8vw,20px);line-height:1.7;margin:8px 0 12px}

    .imgwrap{display:flex;justify-content:center;margin:10px 0}
    .imgwrap[hidden]{display:none !important;} /* ← 隠すときは完全に消す */
    .imgwrap img{
      max-width:100%;
      max-height:68vh;   /* 画面の約2/3に収める */
      height:auto;
      object-fit:contain; /* はみ出さず全体表示 */
      display:none;       /* 読み込み成功時に block にする */
      border-radius:12px;
      border:1px solid var(--border);
    }

    .choices{display:grid;gap:10px}
    .choice{display:flex;align-items:flex-start;gap:10px;background:#f8fafc;border:1px solid var(--border);border-radius:14px;padding:14px;cursor:pointer;transition:transform .1s ease}
    .choice:hover{transform:translateY(-1px)}
    .choice.disabled{opacity:.7;cursor:default;transform:none}
    .bullet{min-width:24px;height:24px;display:inline-grid;place-items:center;border-radius:999px;border:1px solid #94a3b8;color:var(--accent);font-weight:700;background:white}
    .text{flex:1;text-align:left}

    .result{margin-top:12px;font-size:1rem}
    .result.ok{color:var(--ok)}
    .result.bad{color:var(--bad)}
    .explain{margin-top:6px;color:var(--muted);font-size:.95rem}

    /* Bottom bar */
    .bottombar{position:sticky;bottom:0;z-index:30;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border-top:1px solid var(--border)}
    .bar{max-width:880px;margin:0 auto;display:flex;gap:10px;padding:12px 16px;padding-bottom:calc(12px + env(safe-area-inset-bottom))}
    .spacer{flex:1}
    button{appearance:none;border:1px solid var(--border);border-radius:14px;padding:12px 16px;background:#f8fafc;color:var(--text);font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(180deg,#3b82f6,#2563eb);border-color:#2563eb;color:white}
    .btn-ghost{background:transparent}

    @media (min-width:430px){
      .container{padding:18px}
      .choice{padding:16px}
      .bullet{min-width:28px;height:28px}
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <header>
      <div class="container">
        <div class="title">RCCM 問題4-1</div>
      </div>
    </header>

    <main>
      <div class="container">
        <div id="card" class="card" hidden>
          <div class="year-no" id="meta"></div>
          <div class="question" id="q"></div>
          <div class="imgwrap" id="imgwrap" hidden>
            <img id="qimg" alt=""/>
          </div>
          <div class="choices" id="choices"></div>
          <div class="result" id="result"></div>
          <div class="explain" id="explain"></div>
        </div>
        <div id="loading" class="card">読み込み中…</div>
      </div>
    </main>

    <footer class="bottombar">
      <div class="bar">
        <button class="btn-ghost" id="resetBtn" title="正解済みをリセット">リセット</button>
        <div class="spacer"></div>
        <button class="btn-primary" id="nextBtn">次の問題</button>
      </div>
    </footer>
  </div>

  <!-- データチャンク（問題データ本体を4分割で読み込み） -->
  <script src="problems_chunk1_of4.js"></script>
  <script src="problems_chunk2_of4.js"></script>
  <script src="problems_chunk3_of4.js"></script>
  <script src="problems_chunk4_of4.js"></script>

  <!-- 本体ロジック -->
  <script>
    (function(){
      const $ = (s)=>document.querySelector(s);
      const metaEl = $('#meta');
      const qEl = $('#q');
      const imgWrap = $('#imgwrap');
      const imgEl = $('#qimg');
      const choicesEl = $('#choices');
      const resultEl = $('#result');
      const explainEl = $('#explain');
      const cardEl = $('#card');
      const loadingEl = $('#loading');
      const nextBtn = $('#nextBtn');
      const resetBtn = $('#resetBtn');

      const STORAGE_KEY = 'rccm_q_correct_ids_v1';
      const LETTERS = ['a','b','c','d','e','f'];

      // 画像ソースを正規化（空/不正は '' に）
      function sanitizeImageSrc(raw){
        if(raw == null) return '';
        const s0 = String(raw).trim();
        if(!s0 || s0 === 'null' || s0 === 'undefined' || s0 === 'NaN') return '';

        // data URI? data:image/<token>;base64,<payload>
        const m = s0.match(/^data:image\/([^;]+);base64,([\s\S]+)$/);
        if(m){
          const token = m[1].toLowerCase();              // 例: "jpeg", "png", "page2_img2.png" など
          let payload = (m[2] || '').replace(/\s+/g,''); // 改行・空白を除去（iOS対策）
          if(payload.length < 64) return '';             // やたら短いのは壊れているとみなす

          let mime = 'image/png';
          if(token.includes('jpg') || token.includes('jpeg')) mime = 'image/jpeg';
          else if(token.includes('png')) mime = 'image/png';
          else if(token.includes('gif')) mime = 'image/gif';
          // それ以外は png 扱い

          return `data:${mime};base64,${payload}`;
        }

        // 通常URL/相対パスはそのまま
        return s0;
      }

      function loadProblems(){
        let list = [];
        if(Array.isArray(window.PROBLEMS_CHUNKS)){
          for(const chunk of window.PROBLEMS_CHUNKS){
            if(Array.isArray(chunk)) list.push(...chunk);
          }
        }
        // 正規化
        list = list.map(n=>({
          id: String(n.id ?? `${n.year}-${n.number}`),
          year: Number(n.year ?? 0),
          yearDisplay: String(n.yearDisplay ?? ''),
          number: Number(n.number ?? 0),
          question: String(n.question ?? ''),
          image: String(n.image ?? ''),
          choices: Array.isArray(n.choices) ? n.choices.map(x=>String(x)) : [],
          correct: Number.isInteger(n.correct) ? n.correct : -1,
          explanation: String(n.explanation ?? '')
        })).filter(n=>n.choices.length>0);
        return list;
      }

      let ALL = loadProblems();
      let correctSet = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'));

      function saveCorrect(){ localStorage.setItem(STORAGE_KEY, JSON.stringify([...correctSet])); }

      function pickRandom(){
        const pool = ALL.filter(q=>!correctSet.has(q.id));
        if(pool.length === 0) return null;
        const idx = Math.floor(Math.random()*pool.length);
        return pool[idx];
      }

      let current = null;

      function render(q){
        if(!q){
          qEl.textContent = '出題可能な問題がありません。リセットしてください。';
          metaEl.textContent = '';
          imgWrap.hidden = true; imgEl.removeAttribute('src'); imgEl.style.display='none';
          choicesEl.innerHTML=''; resultEl.textContent=''; explainEl.textContent='';
          return;
        }
        metaEl.textContent = `${q.yearDisplay} / No.${q.number}`;
        qEl.textContent = q.question;

        // 画像：毎回確実に初期化 → 正規化して設定 → 成否で表示切替
        imgWrap.hidden = true;
        imgEl.style.display = 'none';
        imgEl.onload = ()=>{ imgEl.style.display='block'; imgWrap.hidden=false; };
        imgEl.onerror = ()=>{
          imgEl.removeAttribute('src');
          imgEl.style.display = 'none';
          imgWrap.hidden = true;
        };

        const src = sanitizeImageSrc(q.image);
        if(src){
          imgEl.src = src;
        }else{
          imgEl.removeAttribute('src');
          imgEl.style.display = 'none';
          imgWrap.hidden = true;
        }

        // 選択肢
        choicesEl.innerHTML='';
        resultEl.textContent=''; resultEl.className='result';
        explainEl.textContent='';
        q.choices.forEach((text,i)=>{
          const div = document.createElement('div');
          div.className = 'choice'; div.dataset.index = String(i);
          const bullet = document.createElement('div'); bullet.className = 'bullet';
          bullet.textContent = LETTERS[i] || String(i+1);
          const span = document.createElement('div'); span.className = 'text'; span.textContent = text;
          div.appendChild(bullet); div.appendChild(span);
          div.addEventListener('click', ()=> onChoose(i));
          choicesEl.appendChild(div);
        });
      }

      function lockChoices(){
        choicesEl.querySelectorAll('.choice').forEach(el=>{
          el.classList.add('disabled');
          el.style.pointerEvents = 'none';
        });
      }

      function onChoose(i){
        if(!current) return;
        const isCorrect = (i === current.correct);
        lockChoices();
        if(isCorrect){
          resultEl.textContent = '正解！';
          resultEl.className = 'result ok';
          correctSet.add(current.id); saveCorrect();
        }else{
          const letter = (LETTERS[current.correct]||String(current.correct+1));
          resultEl.textContent = `不正解。正解は ${letter}`;
          resultEl.className = 'result bad';
        }
        if(current.explanation){ explainEl.textContent = current.explanation; }
      }

      function nextQuestion(){ current = pickRandom(); render(current); }

      function resetProgress(){
        if(confirm('正解済みの記録をリセットしますか？')){
          correctSet.clear(); saveCorrect(); nextQuestion();
        }
      }

      nextBtn.addEventListener('click', nextQuestion);
      resetBtn.addEventListener('click', resetProgress);

      function init(){
        if(!ALL || ALL.length===0){
          loadingEl.textContent = 'データが未設定です。';
        }else{
          loadingEl.hidden = true; cardEl.hidden = false;
          nextQuestion();
        }
      }

      init();
    })();
  </script>
</body>
</html>
