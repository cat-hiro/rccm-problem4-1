<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RCCM 問題4-2</title>
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --text:#1b1f24;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent-weak:#e8efff;
      --ok:#16a34a;
      --ng:#dc2626;
      --border:#e5e7eb;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
      --tap:16px; /* iPhone用タッチ余白 */
    }
    html,body{
      margin:0;padding:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      line-height:1.6;
    }
    header{
      position:sticky;top:0;background:var(--bg);padding:18px 16px 8px;z-index:10;
    }
    .title{
      text-align:center;font-weight:800;letter-spacing:.02em;
      font-size:clamp(18px,4.6vw,24px);
    }
    .wrap{max-width:820px;margin:0 auto;padding:10px 14px 100px;}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:18px 16px;margin-top:12px;
    }
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:14px;margin-bottom:8px;}
    .qtext{font-size:clamp(17px,4.3vw,20px);font-weight:600;word-break:normal;white-space:pre-wrap;}
    .qimage{
      margin:14px 0 6px;display:none;border-radius:12px;border:1px solid var(--border);max-height:38vh;object-fit:contain;background:#fafafa;
    }
    .choices{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
    .choice{
      text-align:left; /* 指定：選択肢左揃え */
      background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px 12px;cursor:pointer;user-select:none;
      font-size:clamp(16px,4.2vw,18px); display:flex;gap:10px;align-items:flex-start;
      touch-action:manipulation;
    }
    .choice:active{transform:translateY(1px)}
    .badge{
      min-width:26px;height:26px;border-radius:8px;display:inline-grid;place-items:center;font-weight:700;border:1px solid var(--border);background:#f9fafb;font-size:14px;
    }
    .explain{
      margin-top:10px;border-top:1px dashed var(--border);padding-top:10px;font-size:15px;color:#111827;white-space:pre-wrap;
    }
    .status{
      margin-top:10px;font-weight:700;font-size:16px;
    }
    .status.ok{color:var(--ok)}
    .status.ng{color:var(--ng)}
    .footer{
      position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid var(--border);
      padding:10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
      display:flex;gap:10px;justify-content:space-between;align-items:center;
    }
    .btn{
      flex:1; text-align:center; border-radius:14px; border:1px solid var(--border); padding:14px 10px;
      font-weight:700; font-size:17px; cursor:pointer; user-select:none; touch-action:manipulation;
      background:#fff;
    }
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
    .btn:active{transform:translateY(1px)}
    .hint{color:var(--muted);font-size:13px}
    .hidden{display:none !important}
    .chip{padding:3px 8px;border-radius:999px;background:var(--accent-weak);color:var(--accent);font-weight:700;font-size:12px;border:1px solid #d9e5ff}
  </style>
</head>
<body>
  <header>
    <div class="title">RCCM 問題4-2</div>
  </header>

  <div class="wrap">
    <div class="card" id="qCard">
      <div class="meta">
        <div id="metaYear" class="chip">年度</div>
        <div id="metaNo" class="chip">No.</div>
        <div id="metaProgress" class="hint">正解済: <span id="doneCount">0</span></div>
      </div>

      <img id="qImage" alt="問題画像" class="qimage" />
      <div class="qtext" id="qText">読み込み中…</div>

      <div class="choices" id="choices"></div>

      <div id="status" class="status hidden"></div>
      <div id="explain" class="explain hidden"></div>
    </div>
  </div>

  <div class="footer">
    <button id="nextBtn" class="btn primary">次の問題</button>
    <button id="resetBtn" class="btn">正解履歴リセット</button>
  </div>

  <!-- PapaParse（CSV安全パース用）※1ファイル運用のためCDN読込 -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>

  <script>
  // ===== 設定 =====
  // CSVは index.html と同じ階層に「problems.csv」という名前で置いてください（UTF-8 BOM推奨）
  const CSV_PATH = 'problems.csv';

  // ===== ユーティリティ =====
  const fullWidthMap = {'ａ':'a','ｂ':'b','ｃ':'c','ｄ':'d','Ａ':'a','Ｂ':'b','Ｃ':'c','Ｄ':'d'};
  const badgeLetters = ['a','b','c','d','e','f'];

  function nfkcLower(s){ return (s ?? '').toString().trim().normalize('NFKC').toLowerCase(); }
  function normalizeKey(s){
    s = nfkcLower(s);
    if (fullWidthMap[s]) return fullWidthMap[s];
    // 先頭1文字がa-dなら抽出（例: "a) xxx", "a．xxx"）
    if (/^[a-d]/.test(s)) return s[0];
    return s;
  }
  // choices文字列を柔軟に分割（"||" / "｜" / "|" / "／" / "、" など想定）
  function splitChoices(raw){
    const t = (raw ?? '').toString().trim();
    const sep = ['||','｜','|','／','、',';','／／'].find(sp => t.includes(sp));
    const arr = sep ? t.split(sep) : t.split('\t');
    return arr.map(x => x.trim()).filter(Boolean);
  }
  // 画像srcを決定（空→null, data:URL, http/https, それ以外は images/プレーン名）
  function resolveImageSrc(v){
    if (!v) return null;
    const s = v.toString().trim();
    if (!s) return null;
    const lower = s.toLowerCase();
    if (lower.startsWith('data:image/')) return s;          // Base64
    if (lower.startsWith('http://') || lower.startsWith('https://')) return s; // URL
    // ファイル名とみなす（images/ 配下）
    return 'images/' + s;
  }
  function setImage(imgEl, srcVal){
    if (!srcVal){ hideImage(imgEl); return; }
    imgEl.onload = () => { imgEl.style.display = 'block'; };
    imgEl.onerror = () => { hideImage(imgEl); };
    imgEl.src = srcVal;
  }
  function hideImage(imgEl){
    imgEl.removeAttribute('src');
    imgEl.style.display = 'none';
  }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }
  function choiceBadge(idx){ return `<span class="badge">${badgeLetters[idx] ?? '?'}</span>`; }

  // ===== 状態 =====
  let bank = [];             // 全問題
  let pool = [];             // 出題プール（未正解のみからランダム）
  let current = null;        // 現在の問題
  let answeredIds = new Set(JSON.parse(localStorage.getItem('rccm_done_ids') || '[]')); // 正解済みID

  function persistDone(){
    localStorage.setItem('rccm_done_ids', JSON.stringify([...answeredIds]));
    document.getElementById('doneCount').textContent = answeredIds.size;
  }

  // 問題レコードからユニークID（年-番号）を作成
  function qid(row){
    const y = (row.yearDisplay || row.year || '').toString().trim();
    const n = (row.number || '').toString().trim();
    return `${y}#${n}`;
  }

  // ===== 表示 =====
  function renderQuestion(q){
    current = q;

    // メタ
    document.getElementById('metaYear').textContent = (q.yearDisplay || q.year || '').toString().trim() || '年度';
    document.getElementById('metaNo').textContent = q.number ? `No.${q.number}` : 'No.-';
    document.getElementById('status').className = 'status hidden';
    document.getElementById('explain').className = 'explain hidden';
    document.getElementById('explain').textContent = '';

    // 本文
    document.getElementById('qText').textContent = (q.question || '').toString().trim();

    // 画像
    const imgEl = document.getElementById('qImage');
    const src = resolveImageSrc(q.image_placeholder);
    setImage(imgEl, src);

    // 選択肢
    const holder = document.getElementById('choices');
    holder.innerHTML = '';
    const rawChoices = splitChoices(q.choices);
    // a,b,c,d…の順に整形（CSV内で頭に「a.」「b)」など付与されていてもOK）
    const data = rawChoices.map((t, i) => {
      const key = normalizeKey(t);
      // 先頭キーと本文を分離（例: "a) 〇〇" -> "〇〇"）
      const text = t.replace(/^[a-dＡ-Ｄａ-ｄ][\.)．、\s]*/i,'').trim();
      return {key: badgeLetters[i] || key, label: badgeLetters[i] || key, text};
    });

    // 正解キーを正規化
    const correctKey = normalizeKey(q.correct);

    data.forEach((c,idx) => {
      const btn = document.createElement('button');
      btn.className = 'choice';
      btn.innerHTML = `${choiceBadge(idx)}<div>${c.text}</div>`;
      btn.addEventListener('click', () => checkAnswer(badgeLetters[idx], correctKey, q));
      holder.appendChild(btn);
    });
  }

  function checkAnswer(selectedKey, correctKey, q){
    const status = document.getElementById('status');
    const explain = document.getElementById('explain');

    if (normalizeKey(selectedKey) === correctKey){
      status.className = 'status ok';
      status.textContent = '正解！';
      explain.className = 'explain';
      explain.textContent = (q.explanation || '').toString().trim();
      // 正解済み登録
      answeredIds.add(qid(q));
      persistDone();
      // 次回から再出題しないようプールから除去
      pool = pool.filter(it => qid(it) !== qid(q));
    }else{
      status.className = 'status ng';
      // 正解表示はCSVのcorrect列をそのままNFKC化＋英小文字化して a/b/c/d に揃える
      const shown = correctKey;
      status.textContent = `不正解　正解は ${shown}`;
      explain.className = 'explain';
      explain.textContent = (q.explanation || '').toString().trim();
    }
  }

  function nextQuestion(){
    // 出題プール: 未正解 only
    const candidates = pool.length ? pool : bank.filter(r => !answeredIds.has(qid(r)));
    if (!candidates.length){
      // すべて正解済み→一旦全問題から再構築（ただし仕様で「リセットまで再出題しない」なのでここでは終了案内）
      document.getElementById('qText').textContent = 'すべて正解済みです。下の「正解履歴リセット」で再開できます。';
      hideImage(document.getElementById('qImage'));
      document.getElementById('choices').innerHTML = '';
      document.getElementById('status').className = 'status hidden';
      document.getElementById('explain').className = 'explain hidden';
      return;
    }
    // ランダム1問（「アプリを開いたときに同じ問題が出ないように」→ページ読み込み時にシャッフル済＋毎回乱択）
    const q = candidates[Math.floor(Math.random()*candidates.length)];
    renderQuestion(q);
  }

  function resetDone(){
    answeredIds.clear();
    persistDone();
    // プールを未正解で再構築
    pool = bank.slice();
    nextQuestion();
  }

  // ===== CSVロード =====
  async function loadCSV(){
    // キャッシュを避ける（GitHub Pagesで更新が反映されないのを防ぐ）
    const url = `${CSV_PATH}?t=${Date.now()}`;
    const res = await fetch(url, {cache:'no-store'});
    if (!res.ok) throw new Error('CSVの取得に失敗しました');
    const text = await res.text();

    // BOM除去
    const clean = text.replace(/^\uFEFF/,'');
    return new Promise((resolve,reject)=>{
      Papa.parse(clean, {
        header:true,
        skipEmptyLines:true,
        transformHeader: h => h.trim(),
        complete: r => resolve(r.data),
        error: err => reject(err)
      });
    });
  }

  // ===== 起動 =====
  window.addEventListener('load', async () => {
    document.getElementById('doneCount').textContent = answeredIds.size;

    document.getElementById('nextBtn').addEventListener('click', nextQuestion, {passive:true});
    document.getElementById('resetBtn').addEventListener('click', resetDone, {passive:true});

    try{
      const rows = await loadCSV();

      // 必須列ガード（year/number/question/choices/correct は最低限）
      const needCols = ['year','yearDisplay','number','question','image_placeholder','choices','correct','explanation'];
      const miss = needCols.filter(c => !(c in rows[0]));
      if (miss.length){
        console.warn('見つからない列:', miss);
      }

      // クリーンアップ＆正規化
      bank = rows.map(r => ({
        year: (r.year ?? '').toString().trim(),
        yearDisplay: (r.yearDisplay ?? '').toString().trim(),
        number: (r.number ?? '').toString().trim(),
        question: (r.question ?? '').toString(),
        image_placeholder: (r.image_placeholder ?? '').toString().trim(),
        choices: (r.choices ?? '').toString(),
        correct: nfkcLower(r.correct ?? ''), // ここで正規化
        explanation: (r.explanation ?? '').toString()
      })).filter(r => r.question && r.choices && r.correct);

      // 初期プール（未正解のみ）
      pool = bank.filter(r => !answeredIds.has(qid(r)));
      // 乱順にしておく（「開いたときに同じ問題が出ない」）
      shuffle(pool);

      nextQuestion();
    }catch(err){
      document.getElementById('qText').textContent = '読み込みに失敗しました。CSVの配置やエンコード(UTF-8)をご確認ください。';
      console.error(err);
    }
  });
  </script>
</body>
</html>
