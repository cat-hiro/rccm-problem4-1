<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>RCCM 問題4-2</title>
<style>
  :root{
    --brand:#1976d2;
    --brand-600:#1565c0;
    --ok:#2e7d32;
    --ng:#d32f2f;
    --card:#ffffff;
    --bg:#f5f7fb;
    --text:#1d2630;
    --muted:#5b6b7a;
    --border:#e5e9f1;
    --shadow:0 6px 18px rgba(24,39,75,0.12);
    --radius:14px;
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN","Hiragino Sans","Noto Sans JP","Yu Gothic UI","YuGothic","Meiryo", Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  /* top bar */
  .appbar{
    position:sticky; top:0; z-index:5;
    background:var(--brand);
    color:#fff;
    padding:14px 20px calc(env(safe-area-inset-top) + 14px);
    box-shadow:var(--shadow);
    text-align:center;
    font-weight:700;
    letter-spacing:.5px;
  }

  .wrap{max-width:980px; margin:24px auto 120px; padding:0 16px}
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:18px;
  }
  .meta{font-size:12px; color:var(--muted); margin-bottom:8px}

  .qtext{
    font-size:18px; line-height:1.7; margin:8px 0 14px;
    word-break:break-word;
  }

  .opt{
    display:block; width:100%;
    text-align:left; /* ←選択肢は左揃え */
    background:#fff;
    border:1px solid var(--border);
    border-radius:12px;
    padding:14px 16px;
    margin:10px 0;
    font-size:16px;
    line-height:1.6;
    cursor:pointer;
    transition:transform .02s ease, border-color .15s ease, background .15s ease;
  }
  .opt:active{transform:scale(.998)}
  .opt.correct{border-color:rgba(46,125,50,.4); background:rgba(76,175,80,.06)}
  .opt.wrong{border-color:rgba(211,47,47,.4); background:rgba(244,67,54,.06)}
  .opt .label{
    display:inline-block; min-width:1.6em;
    font-weight:700; color:var(--muted)
  }

  .feedback{
    margin-top:10px; font-size:15px;
    padding:10px 12px; border-left:4px solid var(--border); color:var(--muted);
    white-space:pre-wrap;
  }
  .feedback.ok{border-left-color:var(--ok); color:var(--ok)}
  .feedback.ng{border-left-color:var(--ng); color:var(--ng)}

  .notes{color:var(--muted); font-size:12px; margin-top:12px}
  .notes li{margin:4px 0}

  /* bottom fixed bar (safe-area 対応) */
  .bottom{
    position:fixed; left:0; right:0; bottom:0; z-index:10;
    background:#fff; border-top:1px solid var(--border);
    padding:10px 12px calc(10px + env(safe-area-inset-bottom));
    display:flex; gap:12px; justify-content:center;
  }
  .btn{
    flex:1 1 0; max-width:520px;
    padding:14px 10px; border-radius:12px;
    border:none; font-weight:700; font-size:16px; cursor:pointer;
    color:#fff;
  }
  .btn-primary{background:var(--brand)}
  .btn-primary:active{background:var(--brand-600)}
  .btn-danger{background:var(--ng)}
  .btn-danger:active{background:#b71c1c}

  /* 小さめ端末でも余白を保つ */
  @media (min-width:1200px){ .wrap{margin-top:28px} }
</style>
</head>
<body>
  <div class="appbar">RCCM 問題4-2</div>

  <div class="wrap">
    <div class="card" id="card">
      <div class="meta" id="meta">No.- / 年度 -</div>
      <div class="qtext" id="qtext">読み込み中…</div>
      <div id="options"></div>
      <div class="feedback" id="feedback" hidden></div>

      <ul class="notes">
        <li>出題はランダム / 正解した問題はリセットまで再出題しません。</li>
        <li>各選択肢をタップで即判定。不正解時は「正解は a/b/c/d」+ 解説を表示します。</li>
        <li>出題数は無制限です。</li>
      </ul>
    </div>
  </div>

  <div class="bottom">
    <button class="btn btn-primary" id="nextBtn">次の問題</button>
    <button class="btn btn-danger" id="resetBtn">リセット</button>
  </div>

<script>
(() => {
  const CSV_PATH = 'mondai4-1.csv'; // リポジトリ直下
  const answeredCorrectIds = new Set();
  let allItems = [];
  let current = null; // {id, year, number, question, options:[{text,isCorrect}], explanation}

  const labelOf = i => ['a','b','c','d','e','f','g','h'][i] || String(i+1);

  // --- CSV 読み込み → パース ---
  init();
  async function init(){
    try{
      const res = await fetch(CSV_PATH, {cache:'no-store'});
      if(!res.ok) throw new Error(`CSV fetch failed: ${res.status}`);
      // UTF-8前提。Shift_JIS の場合はリポジトリ側で UTF-8 に保存してください。
      const text = await res.text();
      const rows = parseCSV(text);
      allItems = rows.map((r, idx) => normalizeRecord(r, idx)).filter(Boolean);
      nextQuestion();
    }catch(e){
      showText('読み込みエラー: ' + e.message);
      console.error(e);
    }
  }

  // 簡易CSVパーサ（カンマ区切り / ダブルクオート対応）
  function parseCSV(src){
    const out = [];
    let i=0, cur='', row=[], inQ=false;
    const pushCell=()=>{ row.push(cur); cur=''; };
    const pushRow=()=>{ if(row.length) out.push(row), row=[]; };

    // 正規化（改行）
    src = src.replace(/\r\n?/g, '\n');
    const N = src.length;

    // ヘッダー抽出
    let lineEnd = src.indexOf('\n');
    if(lineEnd === -1) lineEnd = N;
    const headerLine = src.slice(0, lineEnd).trim();
    const headers = headerLine.split(',').map(h => h.trim());
    const body = src.slice(lineEnd+1);

    // 本文を行単位に（クォート内改行あり得るので手で読む）
    const rowsRaw = [];
    cur=''; inQ=false;
    for(let j=0;j<body.length;j++){
      const ch = body[j];
      if(ch === '"'){
        if(inQ && body[j+1] === '"'){ cur+='"'; j++; }
        else inQ = !inQ;
      }else if(ch === '\n' && !inQ){
        rowsRaw.push(cur); cur='';
      }else{
        cur += ch;
      }
    }
    if(cur) rowsRaw.push(cur);

    // 各行をセル分割
    const table = rowsRaw.map(line=>{
      const cells=[]; let c='', q=false;
      for(let k=0;k<line.length;k++){
        const ch=line[k];
        if(ch === '"'){
          if(q && line[k+1] === '"'){ c+='"'; k++; }
          else q = !q;
        }else if(ch === ',' && !q){
          cells.push(c); c='';
        }else{
          c+=ch;
        }
      }
      cells.push(c);
      return Object.fromEntries(headers.map((h,idx)=>[h, (cells[idx]??'').trim()]));
    });

    return table;
  }

  // レコード正規化
  function normalizeRecord(r, idx){
    // 必須フィールド
    const qText = (r.question || '').trim();
    const choicesRaw = (r.choices || '').trim();
    const explanation = (r.explanation || '').trim();
    if(!qText || !choicesRaw) return null;

    // choices は JSON 配列を想定
    let choices;
    try{
      choices = JSON.parse(choicesRaw);
      if(!Array.isArray(choices)) throw 0;
    }catch{
      // セミコロン等で区切られていた場合の救済
      choices = choicesRaw.split(/\s*[;｜|]\s*/);
    }
    choices = choices.filter(s => String(s).trim().length>0).slice(0,8);

    // correct 正規化（a/b/c/d・A/B/C/D・0/1/2/3・1/2/3/4・全角にも対応）
    const ci = normalizeCorrect(r.correct, choices.length);

    // 表示テキスト整形（先頭の「a.」「ａ．」などを剥がす）
    const strip = s => String(s).replace(/^\s*[a-hａ-ｈＡ-Ｈ]\s*[\.．、)）]\s*/i,'').trim();

    // 正解フラグ付きオプションを作成
    let options = choices.map((t,i)=>({ text: strip(t), isCorrect: i===ci }));
    // シャッフル（←ここが今回のポイント。isCorrect を保持したまま並び替える）
    options = shuffle(options);

    return {
      id: (r.year||'') + '-' + (r.number||idx),
      year: String(r.yearDisplay || r.year || '').trim(),
      number: String(r.number || '').trim(),
      question: qText,
      options,
      explanation
    };
  }

  function normalizeCorrect(v, len){
    if(v==null) return 0;
    let s = String(v).trim();
    // 全角小文字を半角化
    s = s.replace(/[ａ-ｚＡ-Ｚ]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
    s = s.replace(/[０-９]/g, d => String.fromCharCode(d.charCodeAt(0) - 0xFEE0));
    // a/b/c/d
    const m = s.match(/^[a-h]/i);
    if(m){ return m[0].toLowerCase().charCodeAt(0) - 'a'.charCodeAt(0); }
    // 1〜
    if(/^\d+$/.test(s)){
      const n = parseInt(s,10);
      if(n>=1 && n<=len) return n-1;
      if(n>=0 && n<len)   return n;
    }
    // フォールバック
    return 0;
  }

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  // --- 出題 ---
  function nextQuestion(){
    const pool = allItems.filter(q => !answeredCorrectIds.has(q.id));
    if(pool.length === 0){
      showText('全ての問題に正解しました！「リセット」で再開できます。');
      renderMeta('-', '-');
      return;
    }
    current = pool[Math.floor(Math.random()*pool.length)];
    renderQuestion(current);
  }

  function renderQuestion(q){
    renderMeta(q.number || '-', q.year || '-');
    document.getElementById('qtext').textContent = q.question;

    const box = document.getElementById('options');
    box.innerHTML = '';
    document.getElementById('feedback').hidden = true;

    q.options.forEach((opt, idx) => {
      const btn = document.createElement('button');
      btn.className = 'opt';
      btn.innerHTML = `<span class="label">${labelOf(idx)}.</span> ${escapeHtml(opt.text)}`;
      btn.addEventListener('click', () => onAnswer(q, idx));
      box.appendChild(btn);
    });
  }

  function renderMeta(no, year){
    document.getElementById('meta').textContent = `No.${no} / ${year}`;
  }

  function onAnswer(q, chosenIdx){
    const optsEl = [...document.querySelectorAll('.opt')];
    const correctIdx = q.options.findIndex(o => o.isCorrect);
    const feedback = document.getElementById('feedback');

    // 見た目
    optsEl.forEach((el,i)=>{
      el.disabled = true;
      if(i===correctIdx) el.classList.add('correct');
      if(i===chosenIdx && i!==correctIdx) el.classList.add('wrong');
    });

    if(chosenIdx === correctIdx){
      feedback.className = 'feedback ok';
      feedback.hidden = false;
      feedback.textContent = '正解！';
      // 正解済みとして記録（リセットまで出さない）
      answeredCorrectIds.add(q.id);
    }else{
      feedback.className = 'feedback ng';
      feedback.hidden = false;
      const correctLabel = labelOf(correctIdx);
      const explain = q.explanation ? `\n解説：${q.explanation}` : '';
      feedback.textContent = `不正解。正解は ${correctLabel}。${explain}`;
    }
  }

  function showText(msg){
    document.getElementById('qtext').textContent = msg;
    document.getElementById('options').innerHTML = '';
    document.getElementById('feedback').hidden = true;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  // --- UI ボタン ---
  document.getElementById('nextBtn').addEventListener('click', nextQuestion);
  document.getElementById('resetBtn').addEventListener('click', () => {
    answeredCorrectIds.clear();
    nextQuestion();
  });

})();
</script>
</body>
</html>
