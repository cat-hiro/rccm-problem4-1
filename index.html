<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
  />
  <title>RCCM 問題4-2</title>
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --primary:#2563eb;
      --primary-press:#1e40af;
      --correct:#16a34a;
      --incorrect:#dc2626;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      color:var(--text);
      background:var(--bg);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:var(--bg);
      padding:16px 16px 8px;
      border-bottom:1px solid var(--border);
    }
    .title{
      text-align:center;
      font-weight:700;
      font-size:20px;
      letter-spacing:0.02em;
    }
    main{
      padding:12px 12px 88px; /* 余白 + 下部固定バー分 */
      max-width:900px;
      margin:0 auto;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow:0 1px 2px rgb(0 0 0 / 5%);
    }
    .meta{
      display:flex; gap:8px; align-items:center; color:var(--muted);
      font-size:12px; margin-bottom:8px; flex-wrap:wrap;
    }
    .qtext{
      font-size:18px; line-height:1.6; margin:8px 0 12px;
      word-break:break-word; white-space:pre-wrap;
    }
    .imgWrap{
      width:100%; margin:8px 0 12px; display:none;
    }
    .imgWrap img{
      max-width:100%; height:auto; display:block;
      border-radius:12px; border:1px solid var(--border);
      background:#fff;
    }
    .choices{ display:grid; gap:10px; }
    .choice{
      display:flex; gap:12px; align-items:flex-start;
      text-align:left; /* 左揃え指定 */
      padding:12px 14px;
      background: #fff;
      border:1px solid var(--border);
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      transition:transform .02s ease-in-out, border-color .2s, box-shadow .2s;
    }
    .choice:active{ transform:scale(.99) }
    .choice-label{
      font-weight:700; min-width:1.6em; text-transform:lowercase; color:var(--muted);
    }
    .choice-text{ flex:1; }
    .choice.correct{ border-color: var(--correct); box-shadow:0 0 0 3px rgba(22,163,74,.12) }
    .choice.incorrect{ border-color: var(--incorrect); box-shadow:0 0 0 3px rgba(220,38,38,.12) }

    .feedback{
      margin-top:12px; border-top:1px dashed var(--border); padding-top:12px;
      font-size:15px;
    }
    .feedback .ok{ color:var(--correct); font-weight:700 }
    .feedback .ng{ color:var(--incorrect); font-weight:700 }
    .explanation{ color:var(--muted); margin-top:6px; white-space:pre-wrap }

    .stickyBar{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:linear-gradient(180deg, rgba(247,247,251,0.4), var(--bg));
      border-top:1px solid var(--border);
      backdrop-filter: blur(6px);
    }
    .barInner{
      max-width:900px; margin:0 auto; display:flex; gap:10px;
    }
    button{
      -webkit-tap-highlight-color:transparent;
      appearance:none; border:1px solid transparent; border-radius:12px;
      padding:14px 16px; font-weight:700; font-size:16px; flex:1;
      cursor:pointer;
    }
    .primary{
      background:var(--primary); color:white;
    }
    .primary:active{ background:var(--primary-press) }
    .secondary{
      background:#fff; color:var(--text); border-color:var(--border);
    }
    .pill{
      display:inline-block; padding:.2em .6em; border:1px solid var(--border);
      border-radius:999px; background:#fff; color:var(--muted); font-size:11px;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">RCCM 問題4-2</div>
  </header>

  <main>
    <section id="card" class="card" aria-live="polite">
      <div id="meta" class="meta"></div>
      <div id="qtext" class="qtext">読み込み中…</div>
      <div id="imgWrap" class="imgWrap"><img id="qimg" alt="問題画像" loading="lazy"></div>
      <div id="choices" class="choices"></div>
      <div id="feedback" class="feedback" hidden></div>
    </section>
  </main>

  <div class="stickyBar">
    <div class="barInner">
      <button id="nextBtn" class="primary">次の問題</button>
      <button id="resetBtn" class="secondary">リセット</button>
    </div>
  </div>

<script>
(() => {
  const CSV_PATH = './problems.csv'; // 同じフォルダに置く

  // 端末で文字化けを根絶するための「超しぶとい」ローダ
  async function loadCsvText() {
    // 1) ArrayBufferで取得
    const res = await fetch(CSV_PATH, { cache: 'no-store' });
    if (!res.ok) throw new Error('CSVを取得できませんでした');
    const buf = await res.arrayBuffer();

    // 2) UTF-8でデコード → ヘッダが期待通りか判定
    const utf8 = new TextDecoder('utf-8').decode(buf);
    if (looksValidHeader(utf8)) return stripBOM(utf8);

    // 3) Shift_JISでデコード（cp932）
    try {
      const sjis = new TextDecoder('shift_jis').decode(buf);
      if (looksValidHeader(sjis)) return sjis;
    } catch (e) {
      // 一部ブラウザで非対応の場合があるが、Safari/Chrome/Firefox は対応
    }

    // 4) それでもダメなら UTF-8 を返す（表示はされるように）
    return stripBOM(utf8);
  }

  function looksValidHeader(txt){
    // 最初の行を見て、列名が期待どおりかを見る
    const first = txt.split(/\r?\n/,1)[0] ?? '';
    const want = ['year','yearDisplay','number','question','image_placeholder','choices','correct','explanation'];
    // カンマ数が一致し、必須名が含まれているか簡易判定
    return want.every(k => first.includes(k));
  }

  function stripBOM(s){
    return s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s;
  }

  // 小さめのCSVパーサ（ダブルクォート対応）
  function parseCSV(text){
    const rows = [];
    let i=0, field='', row=[], inQuotes=false;
    while(i < text.length){
      const c = text[i];
      if (inQuotes){
        if (c === '"'){
          if (text[i+1] === '"'){ field += '"'; i+=2; continue; } // エスケープ
          inQuotes = false; i++; continue;
        }
        field += c; i++; continue;
      }else{
        if (c === '"'){ inQuotes = true; i++; continue; }
        if (c === ','){ row.push(field); field=''; i++; continue; }
        if (c === '\n'){ row.push(field); rows.push(row); field=''; row=[]; i++; continue; }
        if (c === '\r'){ i++; continue; } // CRは捨てる
        field += c; i++; continue;
      }
    }
    // 末尾
    row.push(field); rows.push(row);
    // 空行除去
    return rows.filter(r => r.some(v => v.trim()!==''));
  }

  function rowsToObjects(rows){
    const header = rows[0];
    return rows.slice(1).map(r => {
      const o = {};
      header.forEach((k,idx)=>{ o[k]= r[idx] ?? '' });
      return o;
    });
  }

  // 状態
  let allQuestions = [];
  const doneCorrect = new Set(); // 正解したindexを保持（リセットまで再出題しない）
  let currentIndex = -1;

  // 初期化
  (async function init(){
    try{
      const csvText = await loadCsvText();
      const rows = parseCSV(csvText);
      const objs = rowsToObjects(rows);
      // 正規化
      allQuestions = objs.map((o,idx) => {
        // choicesはJSON配列を想定
        let choices = [];
        try {
          choices = JSON.parse(o.choices);
        } catch {
          // 万一ダブルクォートが壊れていた場合の保険
          const fixed = o.choices.replace(/''/g,'"').replace(/“|”/g,'"').replace(/‘|’/g,"'");
          choices = JSON.parse(fixed);
        }
        // correctは0始まりの数字を想定
        const correct = Number(o.correct);
        return {
          idx: idx,
          year: o.year,
          yearDisplay: o.yearDisplay || o.year,
          number: o.number,
          question: o.question,
          img: (o.image_placeholder || '').trim(),
          choices,
          correct,
          explanation: o.explanation || ''
        };
      }).filter(q => Array.isArray(q.choices) && q.choices.length>0);

    }catch(e){
      console.error(e);
      document.getElementById('qtext').textContent = 'CSVの読み込みに失敗しました。problems.csv が同じフォルダにあるか、文字コード(UTF-8推奨)をご確認ください。';
      return;
    }

    pickAndRender();
    document.getElementById('nextBtn').addEventListener('click', ()=> pickAndRender());
    document.getElementById('resetBtn').addEventListener('click', ()=> {
      doneCorrect.clear();
      pickAndRender(true);
    });
  })();

  function pickAndRender(force=false){
    const pool = allQuestions.filter(q => force ? true : !doneCorrect.has(q.idx));
    if (pool.length === 0){
      renderMessage('すべて正解済みです。リセットすると再挑戦できます。');
      return;
    }
    const q = pool[Math.floor(Math.random()*pool.length)];
    currentIndex = q.idx;
    renderQuestion(q);
  }

  function renderMessage(msg){
    const meta = document.getElementById('meta');
    const qtext = document.getElementById('qtext');
    const choices = document.getElementById('choices');
    const imgWrap = document.getElementById('imgWrap');
    const feedback = document.getElementById('feedback');

    meta.innerHTML = '';
    qtext.textContent = msg;
    choices.innerHTML = '';
    imgWrap.style.display = 'none';
    feedback.hidden = true;
  }

  function renderQuestion(q){
    const meta = document.getElementById('meta');
    const qtext = document.getElementById('qtext');
    const choices = document.getElementById('choices');
    const imgWrap = document.getElementById('imgWrap');
    const qimg = document.getElementById('qimg');
    const feedback = document.getElementById('feedback');

    meta.innerHTML = `
      <span class="pill">${escapeHTML(q.yearDisplay ?? '')}</span>
      <span class="pill">No.${escapeHTML(q.number ?? '')}</span>
    `;
    qtext.textContent = q.question || '';

    // 画像
    if (q.img){
      qimg.src = q.img;
      qimg.onerror = () => { imgWrap.style.display='none'; };
      imgWrap.style.display = '';
    }else{
      imgWrap.style.display = 'none';
      qimg.removeAttribute('src');
    }

    // 選択肢
    choices.innerHTML = '';
    feedback.hidden = true;
    const labels = ['a','b','c','d','e','f','g','h'];
    q.choices.forEach((t, i)=>{
      const btn = document.createElement('div');
      btn.className = 'choice';
      btn.setAttribute('role','button');
      btn.setAttribute('tabindex','0');
      btn.innerHTML = `
        <div class="choice-label">${labels[i] ?? String(i+1)}</div>
        <div class="choice-text">${escapeHTML(String(t))}</div>
      `;
      btn.addEventListener('click', ()=> handleAnswer(q, i, btn, choices, feedback, labels));
      btn.addEventListener('keydown', (ev)=> {
        if (ev.key === 'Enter' || ev.key === ' '){ ev.preventDefault(); btn.click(); }
      });
      choices.appendChild(btn);
    });
  }

  function handleAnswer(q, chosenIdx, btnEl, containerEl, feedbackEl, labels){
    // 既に判定済みなら無視
    if (containerEl.dataset.locked === '1') return;
    containerEl.dataset.locked = '1';

    // 判定（数値インデックスで厳密判定）
    const isCorrect = Number(chosenIdx) === Number(q.correct);

    // 見た目
    [...containerEl.children].forEach((el, i) => {
      if (i === q.correct) el.classList.add('correct');
      if (i === chosenIdx && !isCorrect) el.classList.add('incorrect');
    });

    // フィードバック
    const correctLabel = labels[q.correct] ?? String(q.correct+1);
    if (isCorrect){
      feedbackEl.innerHTML = `<span class="ok">正解！</span>${q.explanation ? `<div class="explanation">${escapeHTML(q.explanation)}</div>`:''}`;
      doneCorrect.add(q.idx);
    }else{
      feedbackEl.innerHTML =
        `<span class="ng">不正解　正解は ${correctLabel}</span>` +
        (q.explanation ? `<div class="explanation">解説：${escapeHTML(q.explanation)}</div>` : '');
    }
    feedbackEl.hidden = false;

    // 次の問題にすぐ進みたい人向けに、数秒で自動で次へ（任意）
    // setTimeout(()=> pickAndRender(), 1200);
  }

  function escapeHTML(s){
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
})();
</script>
</body>
</html>
